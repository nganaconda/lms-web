<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a Question</title>
    <link rel="stylesheet" href="/static/css/addQuestion_style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-container">
            <button class="home-button" onclick="location.href='/portfolio/'">
                <img src="/static/home.png" alt="Home">
            </button>
            <div class="header-right">
                <button onclick="location.href='/profile/'">{{ username }}</button>
                <button onclick="location.href='/'">Logout</button>
            </div>
        </div>
    </header>
    <div class="main-container">
        <aside>
            <div class="logo-container">
                <img src="/static/logo.png" alt="Logo">
            </div>
            <nav>
                <ul>
                    <li><a href="/portfolio/">My Tests</a></li>
                    <li><a href="/questions/">My Test Questions</a></li>
                    <li><a href="/professor-grades/">My Students Grades</a></li>
                </ul>
            </nav>
        </aside>
        <main>
            <section class="add_question">
                <h1>Add a Question</h1>
                <form method="post">
                    {% csrf_token %}
                    
                    <div>
                        <h2>Question Details</h2>
                        {{ form.non_field_errors }}
                        <div>
                            <label for="id_question">Question:</label>
                            {{ form.question }}
                        </div>
                        <div>
                            <label for="id_type">Type:</label>
                            {{ form.type }}
                        </div>
                        <div>
                            <label for="id_answer_type">Answer Type:</label>
                            {{ form.answerType }}
                        </div>
                        <div>
                            <label for="id_difficulty">Difficulty:</label>
                            <input type="number" id="id_difficulty" name="difficulty" min="1" max="4">
                        </div>
                    </div>
                
                    <div>
                        <h2 id="id_attributes-title">Attributes</h2>
                        {{ formset.management_form }}
                        <div id="attributes-container">
                            {% for subform in formset %}
                                <div class="attribute-form">
                                    <div class="attribute-input-container">
                                        {{ subform.answer.label_tag }} {{ subform.answer }}
                                        <button type="button" class="remove-attribute"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <button type="button" id="add-attribute">Add Another Attribute</button>
                    </div>
                
                    <div>
                        <h2>Right Answer</h2>
                        <label for="id_rightAnswerText">Right Answer:</label>
                        {{ form.rightAnswerText }}
                    </div>
                
                    <button type="submit">Save Question</button>
                </form>
            </section>
        </main>        
    </div>
    <footer>
        <p>&copy; 2024 AUEB LMS</p>
    </footer>

    <script>
        function attachRemoveEvent(button) {
            button.addEventListener('click', function () {
                var container = document.getElementById('attributes-container');
                var totalForms = document.getElementById('id_form-TOTAL_FORMS');
                var formCount = parseInt(totalForms.value);

                // Remove the parent form container of the button clicked
                var formToRemove = this.closest('.attribute-form');
                formToRemove.remove();

                // Update total form count
                totalForms.value = formCount - 1;

                // Re-index the remaining forms dynamically
                reindexForms();

                // After re-indexing, refresh the event listeners for all remove buttons
                refreshRemoveEvents();

                // After removal, disable deletion if only one form is left
                toggleRemoveButtons();
            });
        }

        // Function to re-index forms after a form is removed
        function reindexForms() {
            var container = document.getElementById('attributes-container');
            var forms = container.querySelectorAll('.attribute-form');
            
            forms.forEach(function (form, index) {
                var regex = /form-(\d+)-/g;
                form.innerHTML = form.innerHTML.replace(regex, `form-${index}-`);
            });
        }

        // Function to refresh the remove event listeners after re-indexing or adding a form
        function refreshRemoveEvents() {
            document.querySelectorAll('.remove-attribute').forEach(function (button) {
                // Remove any previous event listeners attached to the button
                var newButton = button.cloneNode(true);
                button.replaceWith(newButton);
                attachRemoveEvent(newButton);
            });
        }

        function toggleRemoveButtons() {
            var totalForms = document.getElementById('id_form-TOTAL_FORMS').value;
            var removeButtons = document.querySelectorAll('.remove-attribute');

            // Disable all remove buttons if only one form remains, else enable them
            if (parseInt(totalForms) === 1) {
                removeButtons.forEach(function (button) {
                    button.disabled = true;
                });

                // Clear the input field if there's only one form left
                var onlyForm = document.querySelector('.attribute-form input');
                if (onlyForm) {
                    onlyForm.value = ''; // Clear the content of the last remaining form's input
                }
            } else {
                removeButtons.forEach(function (button) {
                    button.disabled = false;
                });
            }
        }

        // Function to add a new attribute form
        document.getElementById('add-attribute').addEventListener('click', function () {
            var container = document.getElementById('attributes-container');
            var totalForms = document.getElementById('id_form-TOTAL_FORMS');
            var formCount = parseInt(totalForms.value);
            var newForm = container.children[0].cloneNode(true);

            // Clear the input value of the cloned form
            newForm.querySelector('input').value = '';

            // Re-index the new form
            var regex = new RegExp(`form-(\\d+)-`, 'g');
            newForm.innerHTML = newForm.innerHTML.replace(regex, `form-${formCount}-`);

            // Append the new form to the container
            container.appendChild(newForm);

            // Update the total form count
            totalForms.value = formCount + 1;

            // Attach the remove event to the new form's remove button
            attachRemoveEvent(newForm.querySelector('.remove-attribute'));

            // Refresh all event listeners after adding a new form
            refreshRemoveEvents();

            // Ensure remove buttons are enabled when more than one form exists
            toggleRemoveButtons();
        });

        // Attach remove events to any existing remove buttons on page load
        document.querySelectorAll('.remove-attribute').forEach(attachRemoveEvent);

        // On page load, check if removal buttons should be enabled or disabled
        toggleRemoveButtons();

        
        document.addEventListener('DOMContentLoaded', function() {
            const answerTypeField = document.getElementById('id_answerType');
            const attributesContainer = document.getElementById('attributes-container');
            const addAttributeButton = document.getElementById('add-attribute');
            const rightAnswerText = document.getElementById('id_rightAnswerText');
            const idAttributesTitle = document.getElementById('id_attributes-title');

            // Function to show/hide attributes based on answer type
            function toggleAttributesBasedOnAnswerType() {
                if (answerTypeField.value === 'Text') {
                    // Hide the attributes section and "Add Another Attribute" button
                    attributesContainer.style.display = 'none';
                    addAttributeButton.style.display = 'none';
                    idAttributesTitle.style.display = 'none';
                } else {
                    // Show the attributes section and "Add Another Attribute" button
                    attributesContainer.style.display = 'block';
                    addAttributeButton.style.display = 'inline-block';
                    idAttributesTitle.style.display = 'block';
                }
            }

            // Run on page load
            toggleAttributesBasedOnAnswerType();

            // Listen for changes in the answer type dropdown
            answerTypeField.addEventListener('change', function() {
                toggleAttributesBasedOnAnswerType();
            });
        });
    </script>
</body>
</html>